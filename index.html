/* ============================================================
   LexiTrain ‚Äî JS Complet (Traduction + Dico + Historique + ABC)
   Version Apple Liquid Glass
============================================================ */

/* -----------------------------
   ELEMENTS DOM
----------------------------- */
const inputField = document.getElementById("input");
const translateBtn = document.getElementById("translateBtn");

const resultCard = document.getElementById("resultCard");
const resultTitle = document.getElementById("result-title");
const senseTabs = document.getElementById("senseTabs");
const senseContent = document.getElementById("senseContent");

const pageTranslate = document.getElementById("page-translate");
const pageDictionary = document.getElementById("page-dictionary");

const navTranslate = document.getElementById("navTranslate");
const openDictionary = document.getElementById("openDictionary");

const dictionaryList = document.getElementById("dictionaryList");
const dictionarySearch = document.getElementById("dictionarySearch");

const historyList = document.getElementById("historyList");

const alphabetScroller = document.getElementById("alphabetScroller");

/* ============================================================
   üîÑ PAGE NAVIGATION
============================================================ */
function openTranslatePage() {
    pageTranslate.style.display = "block";
    pageDictionary.style.display = "none";
}

function openDictionaryPage() {
    pageTranslate.style.display = "none";
    pageDictionary.style.display = "block";
    loadDictionary();
}

navTranslate.addEventListener("click", openTranslatePage);
openDictionary.addEventListener("click", openDictionaryPage);

/* ============================================================
   üîé API ‚Üí translate.js (GPT)
============================================================ */
async function fetchWord(word) {
    try {
        const res = await fetch(`/api/translate.js?word=${encodeURIComponent(word)}`);
        return await res.json();
    } catch (err) {
        console.error(err);
        return { error: "Impossible d'obtenir la traduction." };
    }
}

/* ============================================================
   üü¢ LOADER
============================================================ */
function showLoader() {
    resultCard.style.display = "block";
    resultTitle.textContent = "‚è≥ Traduction en cours...";
    senseTabs.innerHTML = "";
    senseContent.innerHTML = `
        <div style="text-align:center; padding:20px; opacity:0.6;">
            ‚è≥ Veuillez patienter...
        </div>
    `;
}

/* ============================================================
   üßπ RESET RESULT
============================================================ */
function clearResult() {
    resultTitle.textContent = "";
    senseTabs.innerHTML = "";
    senseContent.innerHTML = "";
}

/* ============================================================
   üß† RENDER : Sense Tabs
============================================================ */
function renderSenseTabs(entries) {
    senseTabs.innerHTML = "";

    entries.forEach((entry, index) => {
        const pill = document.createElement("div");
        pill.className = "sense-pill";
        if (index === 0) pill.classList.add("active");

        pill.textContent = entry.label;

        pill.addEventListener("click", () => {
            document.querySelectorAll(".sense-pill").forEach(p => p.classList.remove("active"));
            pill.classList.add("active");
            renderSenseContent(entry);
        });

        senseTabs.appendChild(pill);
    });
}

/* ============================================================
   üìö RENDER : Sense Content
============================================================ */
function renderSenseContent(entry) {

    senseContent.innerHTML = "";

    /* Definition */
    if (entry.definition) {
        const def = document.createElement("div");
        def.className = "glass translation-list";
        def.innerHTML = `
            <div class="sense-block-title">Definition</div>
            <div>${entry.definition}</div>
        `;
        senseContent.appendChild(def);
    }

    /* Translations */
    const tList = document.createElement("div");
    tList.className = "glass translation-list";
    tList.innerHTML = `<div class="sense-block-title">Translations (FR)</div>`;

    entry.translations.forEach(t => {
        const item = document.createElement("div");
        item.className = "translation-item";
        item.textContent = t;
        tList.appendChild(item);
    });

    senseContent.appendChild(tList);

    /* Examples */
    const eList = document.createElement("div");
    eList.className = "glass examples-list";
    eList.innerHTML = `<div class="sense-block-title">Examples</div>`;

    entry.examples.forEach(ex => {
        const e = document.createElement("div");
        e.className = "example-block";
        e.innerHTML = `
            <div class="example-text">‚Ä¢ ${ex.src}</div>
            <div class="example-translation">‚Üí ${ex.dest}</div>
        `;
        eList.appendChild(e);
    });

    senseContent.appendChild(eList);

    /* Synonyms */
    const synTitle = document.createElement("div");
    synTitle.className = "sense-block-title";
    synTitle.textContent = "Synonyms (EN)";
    senseContent.appendChild(synTitle);

    const synWrap = document.createElement("div");
    synWrap.className = "glass synonyms-wrapper";

    entry.synonyms.forEach(s => {
        const tag = document.createElement("div");
        tag.className = "synonym-tag";
        tag.textContent = s;
        synWrap.appendChild(tag);
    });

    senseContent.appendChild(synWrap);
}

/* ============================================================
   üü© TRADUCTION
============================================================ */
async function translateWord() {
    const word = inputField.value.trim();
    if (!word) return;

    clearResult();
    showLoader();

    const data = await fetchWord(word);

    if (data.error) {
        resultTitle.textContent = "‚ùå Erreur";
        senseContent.innerHTML = `<div class="error">${data.error}</div>`;
        return;
    }

    resultTitle.textContent = word;

    renderSenseTabs(data.entries);
    renderSenseContent(data.entries[0]);

    addToHistory(word);
}

translateBtn.addEventListener("click", translateWord);
inputField.addEventListener("keypress", (e) => {
    if (e.key === "Enter") translateWord();
});

/* ============================================================
   üïò HISTORIQUE (localStorage)
============================================================ */
function loadHistory() {
    const hist = JSON.parse(localStorage.getItem("lexitrain_history") || "[]");
    historyList.innerHTML = "";

    hist.forEach(word => {
        const item = document.createElement("div");
        item.className = "history-item";
        item.textContent = word;

        item.addEventListener("click", () => {
            inputField.value = word;
            openTranslatePage();
            translateWord();
        });

        historyList.appendChild(item);
    });
}

function addToHistory(word) {
    let hist = JSON.parse(localStorage.getItem("lexitrain_history") || "[]");

    hist = [word, ...hist.filter(w => w !== word)];
    hist = hist.slice(0, 10);

    localStorage.setItem("lexitrain_history", JSON.stringify(hist));

    loadHistory();
}

loadHistory();

/* ============================================================
   üìò DICTIONNAIRE (+ tri alphab√©tique)
============================================================ */
let dictionaryWords = [];

async function loadDictionary(search = "") {
    try {
        const res = await fetch(`/api/list-words.js?q=${search}`);
        const data = await res.json();

        dictionaryWords = data.words || [];

        dictionaryWords.sort((a, b) => a.localeCompare(b));

        dictionaryList.innerHTML = "";

        dictionaryWords.forEach(w => {
            const item = document.createElement("div");
            item.className = "dic-item";
            item.textContent = w;

            item.addEventListener("click", () => {
                inputField.value = w;
                openTranslatePage();
                translateWord();
            });

            dictionaryList.appendChild(item);
        });

    } catch (err) {
        console.error(err);
    }
}

dictionarySearch.addEventListener("input", (e) => {
    loadDictionary(e.target.value.toLowerCase());
});

/* ============================================================
   üî§ ABC SCROLLER (type iPhone)
============================================================ */
const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

function renderAlphabetScroller() {
    alphabetScroller.innerHTML = "";
    alphabet.forEach(letter => {
        const div = document.createElement("div");
        div.textContent = letter;
        div.addEventListener("click", () => scrollToLetter(letter));
        alphabetScroller.appendChild(div);
    });
}

function scrollToLetter(letter) {
    const items = document.querySelectorAll(".dic-item");
    for (let item of items) {
        const word = item.textContent.trim();
        if (word.toUpperCase().startsWith(letter)) {
            item.scrollIntoView({ behavior: "smooth", block: "center" });
            return;
        }
    }
}

renderAlphabetScroller();
/* ============================================================
   üî§ iOS LETTER PREVIEW + HAPTIC FEEDBACK
============================================================ */
const letterPreview = document.getElementById("letterPreview");
let previewTimeout = null;

function vibrate() {
    if (navigator.vibrate) {
        navigator.vibrate(20); // petite impulsion
    }
}

function showLetterPreview(letter) {
    if (!letterPreview) return;

    letterPreview.textContent = letter;
    letterPreview.classList.add("show");

    // reset timer
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(() => {
        letterPreview.classList.remove("show");
    }, 600);
}

// Patch du scroller
function scrollToLetter(letter) {
    const items = document.querySelectorAll(".dic-item");
    
    // Haptic effect
    vibrate();

    // Show big letter on screen
    showLetterPreview(letter);

    for (let item of items) {
        const word = item.textContent.trim();
        if (word.toUpperCase().startsWith(letter)) {
            item.scrollIntoView({ behavior: "smooth", block: "center" });
            return;
        }
    }
}

// Rebind alphabet scroller clicks
function patchAlphabetScroller() {
    const letters = document.querySelectorAll("#alphabetScroller div");
    letters.forEach(l => {
        l.onclick = () => scrollToLetter(l.textContent);
    });
}

patchAlphabetScroller();
